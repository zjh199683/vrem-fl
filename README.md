# VREM-FL
The code in this repository implements algorithms and simulations of the article 
"VREM-FL: Mobility-Aware Computation-Scheduling Co-Design for Vehicular Federated Learning"
published in the IEEE Transactions on Vehicular Technology.
Please jump to the bottom for full citation and all references.

## Learning experiments
Two federated learning tasks are implemented.

1. The first task trains a linear regression model with least squares (LS) cost function. 
The code for this experiment is included in the folder _Least_Squares_FL_code_.
We generate syntehtic dataset for this experiment, however including custom simulated or real-world data is straightforward. 
To change the dataset, it is sufficient to adjust line 20 in the file _main_FL_LS.py_. 
In our implementation, the heterogenity of the synthetic data can be tuned through the input argument ``noniid`` and the parameter ``grad`` in ``utils.getSyntheticDataset()``, whereby smaller ``grad`` means more non-iid data.

2. The second task trains a deep neural network model for semantic segmentation of images. 
The code for this experiment is included in the folder _fl_simulator_nn_. 
We use the real-world dataset ApolloScape in the training experiment, which is freely available online, see [ApolloScape].
ApolloScape gathers frames from video streams acquired by moving cameras and is suited to simulating vehicular training tasks.
To change dataset, it is sufficient to adjust lines 233-240 in the file _run_experiment.py_. 
To change the learned model, local training algorithm, or global aggregation algorithm, it is sufficient to change the relevant methods and parameters in ``get_learner()`` and ``get_client()`` in ``init_clients()`` (for local training and models) and ``get_learner()``, ``get_local_steps_optimizer()``, ``get_local_steps_manager()``, and ``get_aggregator()`` in ``build_experiment()`` (for global training), all in _run_experiment.py_.

## Client mobility and bitrate
In all experiments clients are mobile, which affects the channel quality and upload bitrate. 
The bitrate values for each client and time slot represented in the simulations are uploaded as dictionaries from data files through the method _import_vehicles_data()_ at lines 8 and 201 of the files _Least_Squares_FL_code/main_FL_LS.py_ and _fl_simulator_nn/run_experiment.py_, respectively. 
The data files with bitrate values used in our experiments are freely available at [MobilityData]. 
These are built by generating and estimating realistic Radio Environmental Maps (REMs) of the simulation environments (the cities of Padova, Italy and Rome, Italy),
and by subsequently juxtadposing vehicular trajectories either realistically generated by the simulator of urban mobility [SUMO] run on map provided by [OpenStreetMap] (for simulations in Padova) or taken from the real-wolrd dataset roma/taxi [RomaTaxi] (for simulation in Rome). 
The ground-truth REMs are generated through the MATLAB toolbox [5GToolbox] and they are estimated with the semi-parametric method proposed in [DalFabbro22].

## Schedulig algorithms
Besides the proposed allocation algorithm VREM-FL,
the client scheduling algorithms implemented in the code are:
- random scheduling;
- round robin;
- a fairness-based method adapted from [Ozfatura21];
- a method based on the uplink channel gain at the beginning of the learning rounds adapted from [Chen24].
The client scheduling strategy can be chosen through the _scheduling_ keyword at line 34 of _Least_Squares_FL_code/main_FL_LS.py_ and at line 213 of _fl_simulator_nn/run_experiment.py_, respectively.

The transmission of local models to the aggregator can be chosen between ``optimal`` (VREM-FL), ``min_tx``, and ``min_latency``.
This can be set through the ``tx`` parameter at line 36 of _Least_Squares_FL_code/main_FL_LS.py_
or through the ``tx_strategy`` keyword input parameter of _get_local_steps_optimizer()_ at line 157 of _fl_simulator_nn/run_experiment.py_, respectively.

The number of local steps in the training of local models can be chosen between ``optimal`` (VREM-FL), ``min``, and ``max``.
This can be set through the ``comp`` parameter at line 35 of _Least_Squares_FL_code/main_FL_LS.py_
or through the ``strategy`` keyword input parameter of _get_local_steps_manager()_ at line 164 of _fl_simulator_nn/run_experiment.py_, respectively.

Detailed information about the scheduling algorithms is available in the documentation of the scripts in _Least_Squares_FL_code/Scheduling_algos_ or _fl_simulator_nn/utils/scheduler_utils.py_,
and in our paper [VREMFL].

## How to run
After downloading or creating the datasets with client bitrate values,
all experiments are readily executable by running the scripts _Least_Squares_FL_code/main_FL_LS.py_ and _fl_simulator_nn/run_experiment.py_, respectively.
The latter requires to supply mandatory command line arguments ``experiment`` with the dataset description and ``tx_strategy``.
All command line arguments are visible in the example bash script _fl_simulator_nn/experiment/run_fedavg.sh_.
For this experiment, it is also necessary to download the dataset [ApolloScape].

## References
[5GToolbox] Mathworks. (2023) 5G Toolbox. Accessed on: Nov. 15, 2023.
[Online]. Available: https://www.mathworks.com/help/5g/index.html?s_tid=CRUX_lftnav.

[ApolloScape] X. Huang, X. Cheng, Q. Geng, B. Cao, D. Zhou, P. Wang, Y. Lin, and R. Yang, 
"The apolloscape dataset for autonomous driving,"
in Proc. IEEE CVPR Workshops, 2018, pp. 954-960.

[Chen24] C. Chen, B. Jiang, S. Liu, C. Li, C. Wu, and R. Yin, 
"Efficient federated learning in resource-constrained edge intelligence networks using model compression,"
IEEE Trans. Veh. Technol., vol. 73, no. 2, pp. 2643-2655, 2024.

[DalFabbro22] N. Dal Fabbro, M. Rossi, G. Pillonetto, L. Schenato, and G. Piro, 
"Model-free radio map estimation in massive MIMO systems via semi-parametric Gaussian regression,"
IEEE Wireless Commun. Lett., vol. 11, no. 3, pp. 473-477, 2022.

[OpenStreetMap] OSM. (2023) OpenStreetMap. Accessed on: Nov. 15, 2023. 
[Online]. Available: https://www.openstreetmap.org/#map=6/42.088/12.564.

[Ozfatura21] M. E. Ozfatura, J. Zhao, and D. Gündüz, 
"Fast federated edge learning with overlapped communication and computation and channel-aware fair client scheduling,"
in Proc. IEEE SPAWC, 2021, pp. 311-315.

[RomaTaxi] L. Bracciale, M. Bonola, P. Loreti, G. Bianchi, R. Amici, and A. Rabuffi,
"Crawdad roma/taxi,"
2022, accessed on: Mar. 6, 2024.
[Online]. Available: https://dx.doi.org/10.15783/C7QC7M.

[SUMO] Eclipse. (2023) Simulator of Urban MObility. Accessed on: Nov. 15, 2023. 
[Online]. Available: https://eclipse.dev/sumo/.

[VREMFL] L. Ballotta, N. Dal Fabbro, G. Perin, L. Schenato, M. Rossi, G. Piro,
"VREM-FL: Mobility-Aware Computation-Scheduling Co-Design for Vehicular Federated Learning,"
IEEE Trans. Veh. Technol., 2024.